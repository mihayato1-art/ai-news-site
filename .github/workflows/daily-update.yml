     1	# ğŸ¤– AIæƒ…å ±ã‚µã‚¤ãƒˆ æ¯æ—¥è‡ªå‹•æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ 
     2	name: Daily AI News Auto Update
     3	
     4	on:
     5	  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼ˆJSTæ™‚é–“ï¼‰
     6	  schedule:
     7	    - cron: '0 0 * * *'    # æ¯æ—¥ 09:00 JST (00:00 UTC)
     8	    - cron: '0 9 * * *'    # æ¯æ—¥ 18:00 JST (09:00 UTC)
     9	  
    10	  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    11	  workflow_dispatch:
    12	    inputs:
    13	      force_update:
    14	        description: 'å¼·åˆ¶æ›´æ–°ãƒ¢ãƒ¼ãƒ‰'
    15	        required: false
    16	        default: 'false'
    17	        type: boolean
    18	
    19	env:
    20	  NODE_VERSION: '18'
    21	  TZ: 'Asia/Tokyo'
    22	
    23	jobs:
    24	  collect-and-update:
    25	    runs-on: ubuntu-latest
    26	    
    27	    steps:
    28	    # ğŸ“ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    29	    - name: ğŸ“ Checkout Repository
    30	      uses: actions/checkout@v4
    31	      with:
    32	        token: ${{ secrets.GITHUB_TOKEN }}
    33	        fetch-depth: 0
    34	
    35	    # ğŸ”§ Node.jsç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    36	    - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
    37	      uses: actions/setup-node@v4
    38	      with:
    39	        node-version: ${{ env.NODE_VERSION }}
    40	        cache: 'npm'
    41	
    42	    # ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    43	    - name: ğŸ“¦ Install Dependencies
    44	      run: |
    45	        npm install --production
    46	        npm list --depth=0
    47	
    48	    # ğŸ” ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±è¡¨ç¤º
    49	    - name: ğŸ” System Information
    50	      run: |
    51	        echo "ğŸ• å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S %Z')"
    52	        echo "ğŸ¤– Node.js: $(node --version)"
    53	        echo "ğŸ“¦ npm: $(npm --version)"
    54	        echo "ğŸ’¾ ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡: $(df -h . | tail -1 | awk '{print $5}')"
    55	
    56	    # ğŸ“° AIæœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹åé›†
    57	    - name: ğŸ“° Collect Latest AI News
    58	      env:
    59	        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
    60	        GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
    61	        FORCE_UPDATE: ${{ inputs.force_update }}
    62	      run: |
    63	        echo "ğŸ” AIæœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹åé›†ã‚’é–‹å§‹..."
    64	        node scripts/collect-news.js
    65	        echo "âœ… ãƒ‹ãƒ¥ãƒ¼ã‚¹åé›†å®Œäº†"
    66	        
    67	        # åé›†çµæœã®ç¢ºèª
    68	        if [ -f "data/latest-news.json" ]; then
    69	          echo "ğŸ“Š åé›†ã•ã‚ŒãŸãƒ‹ãƒ¥ãƒ¼ã‚¹ä»¶æ•°: $(cat data/latest-news.json | jq '.news | length')"
    70	        fi
    71	
    72	    # ğŸ› ï¸ AIãƒ„ãƒ¼ãƒ«æƒ…å ±æ›´æ–°
    73	    - name: ğŸ› ï¸ Update AI Tools Information  
    74	      run: |
    75	        echo "ğŸ”§ AIãƒ„ãƒ¼ãƒ«æƒ…å ±ã‚’æ›´æ–°ä¸­..."
    76	        node scripts/update-tools.js
    77	        echo "âœ… ãƒ„ãƒ¼ãƒ«æƒ…å ±æ›´æ–°å®Œäº†"
    78	
    79	    # ğŸ¨ Webã‚µã‚¤ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°
    80	    - name: ğŸ¨ Update Website Content
    81	      run: |
    82	        echo "ğŸ¨ Webã‚µã‚¤ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°ä¸­..."
    83	        node scripts/update-site.js
    84	        echo "âœ… ã‚µã‚¤ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°å®Œäº†"
    85	
    86	    # ğŸ“Š æ›´æ–°çµ±è¨ˆç”Ÿæˆ
    87	    - name: ğŸ“Š Generate Update Statistics
    88	      run: |
    89	        echo "ğŸ“Š æ›´æ–°çµ±è¨ˆã‚’ç”Ÿæˆä¸­..."
    90	        node scripts/generate-stats.js
    91	        echo "âœ… çµ±è¨ˆç”Ÿæˆå®Œäº†"
    92	
    93	    # ğŸ” å¤‰æ›´æ¤œå‡º
    94	    - name: ğŸ” Check for Content Changes
    95	      id: changes
    96	      run: |
    97	        git add .
    98	        if [[ -n $(git diff --cached --name-only) ]]; then
    99	          echo "changes=true" >> $GITHUB_OUTPUT
   100	          echo "ğŸ“ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸ"
   101	          echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
   102	          git diff --cached --name-only | sed 's/^/  - /'
   103	        else
   104	          echo "changes=false" >> $GITHUB_OUTPUT
   105	          echo "â„¹ï¸ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
   106	        fi
   107	
   108	    # ğŸ’¾ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
   109	    - name: ğŸ’¾ Commit Content Changes
   110	      if: steps.changes.outputs.changes == 'true'
   111	      run: |
   112	        git config --local user.email "ai-bot@github-actions.com"
   113	        git config --local user.name "AI News Bot ğŸ¤–"
   114	        
   115	        # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ
   116	        COMMIT_MSG="ğŸ¤– AIæƒ…å ±è‡ªå‹•æ›´æ–° $(date '+%Y-%m-%d %H:%M JST')"
   117	        
   118	        if [ -f "data/latest-news.json" ]; then
   119	          NEWS_COUNT=$(cat data/latest-news.json | jq -r '.totalCount // 0')
   120	          COMMIT_MSG="$COMMIT_MSG - ${NEWS_COUNT}ä»¶ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹"
   121	        fi
   122	        
   123	        git commit -m "$COMMIT_MSG"
   124	        echo "âœ… å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ãŸ: $COMMIT_MSG"
   125	
   126	    # ğŸš€ GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤
   127	    - name: ğŸš€ Deploy to GitHub Pages
   128	      if: steps.changes.outputs.changes == 'true'
   129	      uses: peaceiris/actions-gh-pages@v3
   130	      with:
   131	        github_token: ${{ secrets.GITHUB_TOKEN }}
   132	        publish_dir: ./dist
   133	        publish_branch: gh-pages
   134	        commit_message: "ğŸš€ Deploy AI site update ${{ github.sha }}"
   135	        user_name: 'AI Deploy Bot'
   136	        user_email: 'ai-deploy@github-actions.com'
   137	
   138	    # ğŸ“¤ å¤‰æ›´ã‚’ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥
   139	    - name: ğŸ“¤ Push Changes to Main
   140	      if: steps.changes.outputs.changes == 'true'
   141	      run: |
   142	        git push origin main
   143	        echo "âœ… å¤‰æ›´ã‚’ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
   144	
   145	    # ğŸ“Š å®Ÿè¡Œã‚µãƒãƒªãƒ¼
   146	    - name: ğŸ“Š Execution Summary
   147	      if: always()
   148	      run: |
   149	        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
   150	        echo "ğŸ¤– AIæƒ…å ±ã‚µã‚¤ãƒˆè‡ªå‹•æ›´æ–° å®Ÿè¡Œçµæœ"
   151	        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
   152	        echo "ğŸ• å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S %Z')"
   153	        echo "ğŸ“ å¤‰æ›´æ¤œå‡º: ${{ steps.changes.outputs.changes }}"
   154	        
   155	        if [ -f "data/latest-news.json" ]; then
   156	          echo "ğŸ“° ãƒ‹ãƒ¥ãƒ¼ã‚¹ä»¶æ•°: $(cat data/latest-news.json | jq -r '.totalCount // 0')ä»¶"
   157	          echo "â­ é‡è¦ãƒ‹ãƒ¥ãƒ¼ã‚¹: $(cat data/latest-news.json | jq -r '.news | map(select(.importance >= 7)) | length')ä»¶"
   158	        fi
   159	        
   160	        echo "ğŸ’¾ ä½¿ç”¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: $(du -sh . | cut -f1)"
   161	        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
   162	
   163	  # ğŸ“§ å¤±æ•—æ™‚ã®é€šçŸ¥
   164	  notify-on-failure:
   165	    runs-on: ubuntu-latest
   166	    needs: collect-and-update
   167	    if: failure()
   168	    
   169	    steps:
   170	    - name: ğŸš¨ Send Failure Notification
   171	      run: |
   172	        echo "ğŸš¨ AIæƒ…å ±ã‚µã‚¤ãƒˆã®è‡ªå‹•æ›´æ–°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
   173	        echo "ğŸ“… å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S %Z')"
   174	        echo "ğŸ”— è©³ç´°: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
   175	        
   176	        # å¿…è¦ã«å¿œã˜ã¦Slack/Discordé€šçŸ¥ã‚‚è¿½åŠ å¯èƒ½
   177	        # curl -X POST -H 'Content-type: application/json' \
   178	        #   --data '{"text":"ğŸš¨ AIæƒ…å ±ã‚µã‚¤ãƒˆã®è‡ªå‹•æ›´æ–°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"}' \
   179	        #   ${{ secrets.SLACK_WEBHOOK_URL }}
   180	
   181	  # ğŸ§¹ é€±æ¬¡ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæ—¥æ›œæ—¥ã®ã¿ï¼‰
   182	  weekly-cleanup:
   183	    runs-on: ubuntu-latest
   184	    if: github.event.schedule == '0 0 * * 0'  # æ—¥æ›œæ—¥ã®ã¿
   185	    
   186	    steps:
   187	    - name: ğŸ“ Checkout Repository
   188	      uses: actions/checkout@v4
   189	
   190	    - name: ğŸ§¹ Weekly Cleanup
   191	      run: |
   192	        echo "ğŸ§¹ é€±æ¬¡ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œä¸­..."
   193	        
   194	        # å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
   195	        find logs/ -name "*.log" -mtime +7 -delete 2>/dev/null || true
   196	        
   197	        # å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤  
   198	        find data/archive/ -name "*.json" -mtime +30 -delete 2>/dev/null || true
   199	        
   200	        echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
   201	
   202	    - name: ğŸ“Š Generate Weekly Report
   203	      run: |
   204	        echo "ğŸ“Š é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
   205	        node scripts/generate-weekly-report.js
   206	        echo "âœ… é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
